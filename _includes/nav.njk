<style>
  .navigator {
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    height: 100dvh;
    overflow-x: hidden;
    overflow-y: scroll;
    background: var(--neutral-base-normal);
    border-right: 1px solid var(--neutral-border-soft);
    font-size: var(--font-size-3);
    z-index: 999;
    width: 100dvw;
    max-width: 100dvw;
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;

    @media screen and (min-width: 768px) {
      min-width: var(--size-navigator);
      width: var(--size-navigator);
      transform: translateX(0);
    }
  }

  .navigator.open {
    transform: translateX(0);
  }

  .navigator.closed {
    transform: translateX(-100%);
  }

  .navigator-header {
    position: sticky;
    z-index: 999;
    top: 0;
    left: 0;
    right: 0;
    justify-content: space-between;
    align-items: center;
    display: flex;
    gap: 4px;
    background: var(--neutral-base-normal);
    border-top: 1px solid var(--neutral-border-soft);
    border-bottom: 1px solid var(--neutral-border-soft);
    font-size: var(--font-size-3);

    min-height: var(--size-chrome);
    height: var(--size-chrome);
    padding-left: var(--space);
    padding-right: var(--space);

    a {
      color: var(--neutral-text-contrast);
      text-decoration: none;
    }

    img {
      height: 1.25rem;
      width: 1.25rem;
    }
  }

  .navigator-header-profile {
    user-select: none;
    display: flex;
    align-items: center;
    gap: var(--space);
    color: var(--neutral-text-soft);

    picture {
      display: flex;
    }
  }

  .navigator-buttons {
    display: flex;
    gap: var(--space-half);
  }

  .directory {
    display: flex;
    flex-direction: column;
    padding: var(--space-half);

    a {
      text-decoration: none;

      &:hover,
      &:focus {
        background: var(--neutral-highlight-normal);
        color: var(--neutral-text-contrast);

        iconcontainer svg {
          fill: var(--neutral-text-contrast);
        }
      }
    }
  }

  .directory .active,
  .directory .active:hover,
  .directory .active:focus {
    background: var(--primary-highlight-normal);
    color: var(--primary-text-contrast);
  }

  .directory {
    user-select: none;

    details {
      height: 1.75rem;
      min-height: 1.75rem;
      position: relative;
      width: 100%;
    }

    details[open] {
      top: 0;
      height: initial;
      min-height: initial;

      details {
        a {
          padding-left: 24px;
        }

        .list-item a {
          padding-left: 36px;
        }
      }

      details[open] {
        position: static;
        top: auto;
      }
    }
  }

  .list-item-group {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 1.75rem;
    min-height: 1.75rem;

    a {
      height: 1.75rem;
      min-height: 1.75rem;
      width: 100%;
      position: absolute;
      left: 0;
      right: 0;
      padding-left: 1rem;
      padding-right: var(--space);
      border-radius: var(--border-radius);
    }
  }

  .list-item-group::before {
    content: '';
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    top: 8px;
    left: 2px;
    height: 12px;
    width: 12px;
    z-index: 8;
    cursor: pointer;
    background-color: var(--neutral-text-soft);
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cpath d='M184.49,136.49l-80,80a12,12,0,0,1-17-17L159,128,87.51,56.49a12,12,0,1,1,17-17l80,80A12,12,0,0,1,184.49,136.49Z'/%3E%3C/svg%3E");
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
  }

  details[open] > .list-item-group::before {
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cpath d='M216.49,104.49l-80,80a12,12,0,0,1-17,0l-80-80a12,12,0,0,1,17-17L128,159l71.51-71.52a12,12,0,0,1,17,17Z'/%3E%3C/svg%3E");
  }

  .list-item-group::marker {
    color: transparent;
  }

  .list-item-wrapper {
    display: flex;
    flex-direction: column;
    list-style: none;
    margin-top: 1.75rem;
  }

  .list-item-wrapper .list-item-group {
    /* indent folders within folders*/
    &:before {
      left: 10px;
    }
  }

  details .list-item a {
    padding-left: 24px;
  }

  .list-item {
    display: flex;
    white-space: nowrap;
    min-height: 1.75rem;
    align-items: center;
    width: 100%;
    position: relative;

    a {
      border-radius: var(--border-radius);
      padding-left: 1rem;
      padding-right: var(--space);
      text-decoration: none;
      height: 100%;
      align-items: center;
      width: 100%;
      min-width: 100%;
      z-index: 5;
      text-overflow: ellipsis;
      height: 1.75rem;

      h3 {
        display: flex;
        align-items: center;
        height: 100%;
      }
    }

    .list-item {
      a {
        padding-left: var(--space-3);
      }
    }
  }


  iconcontainer {
    display: flex;
    align-items: center;
    gap: 6px;
    position: relative;
    top: 2px;

    h3 {
      position: relative;
      top: 1px;
    }

    .active & {
      svg {
        fill: var(--primary-text-contrast);
      }
    }

    svg {
      position: relative;
      top: 1px;
      flex-shrink: 0;
      fill: var(--neutral-text-normal);
    }
  }

  .navigator-footer {
    margin-top: auto;
    position: sticky;
    z-index: 999;
    bottom: 0;
    left: 0;
    right: 0;
    border-top: 1px solid var(--neutral-border-soft);
    background: var(--neutral-base-normal);
    display: flex;
    align-items: center;
    gap: var(--space);
    padding-left: var(--space-half);

    min-height: var(--size-chrome);
    height: var(--size-chrome);
    padding-left: var(--space);
    padding-right: var(--space);

    svg {
      margin-left: var(--space-half);
      pointer-events: none;
      fill: var(--neutral-text-soft);
    }

    input {
      width: 100%;
      padding: 0;
      outline: none;
      display: flex;
      align-items: center;
      background: transparent;
      border: none;
    }
  }

  .directory.searching {
    .filtered-out {
      display: none;
    }
    .list-item-group {
      display: none;
    }
    .list-item-wrapper {
      margin-top: 0;
    }
    .list-item a {
      padding-left: var(--space) !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Dark mode toggle
    const darkModeButton = document.querySelector('.toggle-dark-mode');
    const darkModeIcon = darkModeButton ? darkModeButton.querySelector('use') : null;
    const html = document.documentElement;

    function updateDarkModeIcon(scheme) {
      if (!darkModeIcon) return;

      if (scheme === 'dark') {
        darkModeIcon.setAttribute('href', '#sun');
      } else {
        darkModeIcon.setAttribute('href', '#moon');
      }
    }

    // Restore dark mode preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      html.style.colorScheme = 'dark';
      updateDarkModeIcon('dark');
    } else if (savedTheme === 'light') {
      html.style.colorScheme = 'light';
      updateDarkModeIcon('light');
    }

    if (darkModeButton) {
      darkModeButton.addEventListener('click', () => {
        const currentScheme = html.style.colorScheme;

        if (currentScheme === 'dark') {
          html.style.colorScheme = 'light';
          localStorage.setItem('theme', 'light');
          updateDarkModeIcon('light');
        } else {
          html.style.colorScheme = 'dark';
          localStorage.setItem('theme', 'dark');
          updateDarkModeIcon('dark');
        }
      });
    }

    const sidebar = document.querySelector('.navigator');

    // Restore sidebar scroll position or scroll to active item
    const savedScrollPos = sessionStorage.getItem('sidebarScrollPos');
    if (savedScrollPos !== null) {
      sidebar.scrollTop = parseInt(savedScrollPos, 10);
    } else {
      const activeItem = document.querySelector('.directory li.list-item .active');
      if (activeItem) {
        activeItem.scrollIntoView({ block: 'start', behavior: 'instant' });
      }
    }

    // Prevent details toggle when clicking summary links
    document.querySelectorAll('.directory summary').forEach(summary => {
      summary.addEventListener('click', (e) => {
        if (e.target.tagName === 'A' || e.target.closest('a')) {
          e.preventDefault();
          const link = e.target.tagName === 'A' ? e.target : e.target.closest('a');
          window.location.href = link.href;
        }
      });
    });

    // Restore details state from localStorage
    function getDetailsKey(details) {
      const link = details.querySelector('summary a');
      return link ? link.getAttribute('href') : null;
    }

    function saveDetailsState() {
      const state = {};
      document.querySelectorAll('.directory details').forEach(details => {
        const key = getDetailsKey(details);
        if (key) {
          state[key] = details.open;
        }
      });
      localStorage.setItem('detailsState', JSON.stringify(state));
    }

    function restoreDetailsState() {
      const savedState = localStorage.getItem('detailsState');
      if (!savedState) return;

      try {
        const state = JSON.parse(savedState);
        document.querySelectorAll('.directory details').forEach(details => {
          const key = getDetailsKey(details);
          if (key && state.hasOwnProperty(key)) {
            details.open = state[key];
          }
        });
      } catch (e) {
        console.error('Failed to restore details state:', e);
      }
    }

    // Restore state on page load
    restoreDetailsState();

    // Ensure folders containing the active page are always open
    const activeLink = document.querySelector('.directory .active');
    if (activeLink) {
      let parent = activeLink.closest('details');
      while (parent) {
        parent.open = true;
        parent = parent.parentElement.closest('details');
      }
    }

    // Save state whenever a details element is toggled
    document.querySelectorAll('.directory details').forEach(details => {
      details.addEventListener('toggle', saveDetailsState);
    });

    // Toggle details
    const toggleButton = document.querySelector('.toggle-details');
    if (toggleButton) {
      toggleButton.addEventListener('click', () => {
        const allDetails = document.querySelectorAll('.directory details');
        const anyOpen = Array.from(allDetails).some(details => details.open);

        allDetails.forEach(details => {
          details.open = !anyOpen;
        });

        // Save the new state after toggling all
        saveDetailsState();
      });
    }

    // Toggle sidebar with localStorage persistence and responsive behavior
    const breakpoint = 768;

    function isSmallScreen() {
      return window.innerWidth < breakpoint;
    }

    // Restore sidebar state based on screen size
    function restoreSidebarState() {
      const smallScreenOpen = localStorage.getItem('sidebarOpenSmall');
      const largeScreenClosed = localStorage.getItem('sidebarClosedLarge');

      // Clear both classes first
      sidebar.classList.remove('open', 'closed');

      if (isSmallScreen()) {
        // On small screens, closed by default unless explicitly opened
        if (smallScreenOpen === 'true') {
          sidebar.classList.add('open');
        }
      } else {
        // On large screens, open by default unless explicitly closed
        if (largeScreenClosed === 'true') {
          sidebar.classList.add('closed');
        }
      }
    }

    restoreSidebarState();

    // Toggle and save state based on screen size
    document.querySelectorAll('.toggle-sidebar').forEach(button => {
      button.addEventListener('click', () => {
        if (isSmallScreen()) {
          sidebar.classList.toggle('open');
          const isOpen = sidebar.classList.contains('open');
          localStorage.setItem('sidebarOpenSmall', isOpen);
        } else {
          sidebar.classList.toggle('closed');
          const isClosed = sidebar.classList.contains('closed');
          localStorage.setItem('sidebarClosedLarge', isClosed);
        }
      });
    });

    // Handle window resize - restore state when crossing breakpoint
    let wasSmallScreen = isSmallScreen();
    window.addEventListener('resize', () => {
      const nowSmallScreen = isSmallScreen();
      if (wasSmallScreen !== nowSmallScreen) {
        restoreSidebarState();
        wasSmallScreen = nowSmallScreen;
      }
    });

    // Save scroll position when clicking any link in sidebar
    document.querySelectorAll('.navigator a').forEach(link => {
      link.addEventListener('click', () => {
        sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
      });
    });

    // Close sidebar on mobile after clicking a link
    sidebar.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (link && isSmallScreen()) {
        e.preventDefault();
        sidebar.classList.remove('open');
        localStorage.setItem('sidebarOpenSmall', 'false');

        setTimeout(() => {
          window.location.href = link.href;
        }, 0);
      }
    });

    // Navigate between sidebar items with left/right buttons
    function getNavigableItems() {
      const items = [];
      const directory = document.querySelector('.directory');

      // Get all direct children of directory (divs and details)
      directory.childNodes.forEach(node => {
        if (node.nodeType === Node.ELEMENT_NODE) {
          if (node.classList && node.classList.contains('list-item')) {
            // It's a div.list-item - get the link inside
            const link = node.querySelector('a');
            if (link) {
              items.push(link);
            }
          } else if (node.tagName === 'DETAILS') {
            // Add the summary link
            const summaryLink = node.querySelector('summary a');
            if (summaryLink) {
              items.push(summaryLink);
            }

            // If details is open, add all child links
            if (node.open) {
              const childLinks = node.querySelectorAll('ol > li > a, ol > li > details');
              childLinks.forEach(item => {
                if (item.tagName === 'A') {
                  items.push(item);
                } else if (item.tagName === 'DETAILS') {
                  const detailSummaryLink = item.querySelector('summary a');
                  if (detailSummaryLink) {
                    items.push(detailSummaryLink);
                  }
                  if (item.open) {
                    const nestedLinks = item.querySelectorAll('ol > li > a');
                    nestedLinks.forEach(link => items.push(link));
                  }
                }
              });
            }
          }
        }
      });

      return items;
    }

    function navigateToItem(direction) {
      const items = getNavigableItems();
      const currentActive = document.querySelector('.directory .active');

      if (!currentActive || items.length === 0) return;

      const currentIndex = items.indexOf(currentActive);
      if (currentIndex === -1) return;

      let nextIndex;
      if (direction === 'left') {
        nextIndex = currentIndex - 1;
        if (nextIndex < 0) nextIndex = items.length - 1; // Wrap to end
      } else {
        nextIndex = currentIndex + 1;
        if (nextIndex >= items.length) nextIndex = 0; // Wrap to start
      }

      const nextItem = items[nextIndex];
      if (nextItem && nextItem.href) {
        sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
        window.location.href = nextItem.href;
      }
    }

    // Attach navigation to buttons
    const leftButton = document.querySelector('.toggle-left');
    const rightButton = document.querySelector('.toggle-right');

    if (leftButton) {
      leftButton.addEventListener('click', () => navigateToItem('left'));
    }

    if (rightButton) {
      rightButton.addEventListener('click', () => navigateToItem('right'));
    }

    // Search functionality
    const searchInput = document.querySelector('.navigator-footer input');
    const directory = document.querySelector('.directory');
    let noResultsMessage = null;

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();

        // Remove existing no results message
        if (noResultsMessage) {
          noResultsMessage.remove();
          noResultsMessage = null;
        }

        if (query === '') {
          // Reset: show all items and restore original details state
          directory.classList.remove('searching', 'no-results');
          directory.querySelectorAll('li, details').forEach(el => {
            el.classList.remove('filtered-out');
          });
          return;
        }

        // Add searching class
        directory.classList.add('searching');

        // Open all details when searching
        directory.querySelectorAll('details').forEach(details => {
          details.open = true;
        });

        let hasResults = false;

        // Search through all links (only filter individual items, not folders)
        directory.querySelectorAll('a').forEach(link => {
          const text = link.textContent.toLowerCase();
          const listItem = link.closest('li');

          // Only filter items that are in <li> elements (not folder summaries)
          if (listItem && !link.closest('summary')) {
            if (text.includes(query)) {
              listItem.classList.remove('filtered-out');
              hasResults = true;
            } else {
              listItem.classList.add('filtered-out');
            }
          }
        });

        // Hide empty details sections
        directory.querySelectorAll('details').forEach(details => {
          const visibleLinks = Array.from(details.querySelectorAll('li')).filter(
            li => !li.classList.contains('filtered-out')
          );
          if (visibleLinks.length === 0) {
            details.classList.add('filtered-out');
          } else {
            details.classList.remove('filtered-out');
          }
        });

        // Add/remove no-results class and show message
        if (!hasResults) {
          directory.classList.add('no-results');
          noResultsMessage = document.createElement('div');
          noResultsMessage.textContent = 'nah mate, nothin here';
          noResultsMessage.style.padding = '1rem';
          directory.appendChild(noResultsMessage);
        } else {
          directory.classList.remove('no-results');
        }
      });
    }
  });
</script>

<section class="navigator">
  <section class="navigator-header">
    <div class="navigator-header-profile">
      <img height="40" width="40" src="/images/me/avatar.png" alt="Robin Rendle" />
      <a href="/">Robin Rendle</a> / v19
    </div>

    <div class="navigator-buttons">
      <button class="btn btn-icon btn-subtle toggle-details" aria-label="Toggle Folders" type="button">
        <svg height="20" width="20"><use href="#arrows-out-line-vertical"></use></svg>
      </button>
      <button class="btn btn-icon btn-subtle toggle-sidebar" aria-label="Toggle Sidebar" type="button">
        <svg height="30" width="30"><use href="#sidebar-simple"></use></svg>
      </button>
    </div>
  </section>

  <nav class="directory">
    <ul style="list-style: none; padding: 0; margin: 0;">
      <li class="list-item">
        <a href="/" class="{{ page.url | isActive('/') }}">
          <iconcontainer>
            <svg class="icon" height="18" width="18"><use href="#file-md"></use></svg>
            <h3>README</h3>
          </iconcontainer>
        </a>
      </li>
    </ul>
    <details {% if page.url.startsWith('/notes/') and page.url != '/notes/' %}open{% endif %}>
      <summary class="list-item-group">
        <a href="/notes" class="{{ page.url | isActive('/notes') }}">
          <iconcontainer>
            <svg class="icon" height="18" width="18"><use href="#folder"></use></svg>
            <h3>Notes</h3>
          </iconcontainer>
        </a>
      </summary>
      <ol class="list-item-wrapper">
        {% for post in collections.notes | reverse %}
          <li class="list-item">
            <a href="{{ post.url }}" class="{{ page.url | isActive(post.url) }}">
              <iconcontainer>
                <svg class="icon" height="18" width="18"><use href="#note"></use></svg>
                <h3>{{ post.data.title }}</h3>
              </iconcontainer>
            </a>
          </li>
        {% endfor %}
      </ol>
    </details>
    <details {% if page.url.startsWith('/stories/') and page.url != '/stories/' %}open{% endif %}>
      <summary class="list-item-group">
        <a href="/stories" class="{{ page.url | isActive('/stories') }}">
          <iconcontainer>
            <svg class="icon" height="18" width="18"><use href="#folder"></use></svg>
          <h3>Stories</h3>
          </iconcontainer>
        </a>
      </summary>
      <ol class="list-item-wrapper">
        {% for post in collections.stories | reverse %}
          <li class="list-item">
            <a href="{{ post.url }}" class="{{ page.url | isActive(post.url) }}">
              <iconcontainer>
                <svg class="icon" height="18" width="18"><use href="#scroll"></use></svg>
                <h3>{{ post.data.title }}</h3>
              </iconcontainer>
            </a>
          </li>
        {% endfor %}
      </ol>
    </details>
    <details {% if page.url.startsWith('/newsletter/') and page.url != '/newsletter/' %}open{% endif %}>
      <summary class="list-item-group">
        <a href="/newsletter" class="{{ page.url | isActive('/newsletter') }}">
          <iconcontainer>
            <svg class="icon" height="18" width="18"><use href="#folder"></use></svg>
            <h3>Newsletter</h3>
          </iconcontainer>
        </a>
      </summary>
      <ol class="list-item-wrapper">
        {% for post in collections.newsletter | reverse %}
          <li class="list-item">
            <a href="{{ post.url }}" class="{{ page.url | isActive(post.url) }}">
              <iconcontainer>
                <svg class="icon" height="18" width="18"><use href="#note"></use></svg>
                <h3>{{ post.data.title }}</h3>
              </iconcontainer>
            </a>
          </li>
        {% endfor %}
      </ol>
    </details>
    <details {% if page.url.startsWith('/photos/') and page.url != '/photos/' %}open{% endif %}>
      <summary class="list-item-group">
        <a href="/photos" class="{{ page.url | isActive('/photos') }}">
          <iconcontainer>
            <svg class="icon" height="18" width="18"><use href="#folder"></use></svg>
            <h3>Photos</h3>
          </iconcontainer>
        </a>
      </summary>
      <ol class="list-item-wrapper">
        {% for folder in photoNav | reverse %}
          <li class="list-item">
            <details {% if page.url.startsWith('/photos/' + folder.slug + '/') and page.url != '/photos/' + folder.slug + '/' %}open{% endif %}>
              <summary class="list-item-group">
                <a href="/photos/{{ folder.slug }}/" class="{{ page.url | isActive('/photos/' + folder.slug) }}">
                  <iconcontainer>
                    <svg class="icon" height="18" width="18"><use href="#folder"></use></svg>
                    <h3>{{ folder.name }}</h3>
                  </iconcontainer>
                </a>
              </summary>
              <ol class="list-item-wrapper">
                {% for photo in folder.photos %}
                  <li class="list-item">
                    <a href="{{ photo.url }}" class="{{ page.url | isActive(photo.url) }}">
                      <iconcontainer>
                        <svg class="icon" height="18" width="18"><use href="#image"></use></svg>
                        <h3>{{ photo.title }}</h3>
                      </iconcontainer>
                    </a>
                  </li>
                {% endfor %}
              </ol>
            </details>
          </li>
        {% endfor %}
      </ol>
    </details>
  </nav>

  <section class="navigator-footer">
    <svg height="18" width="18"><use href="#funnel-simple"></use></svg>
    <input type="text" placeholder="Filter">
  </section>
</section>
