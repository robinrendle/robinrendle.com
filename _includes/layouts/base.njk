<!-- So. Many. Websites.  -->
<!DOCTYPE html>
<html lang="en" class={{templateClass}}>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
    <title>{{ title }}</title>
    <meta
      name="description"
      content="{{ extract | default(metadata.description) }}"/>
    <meta property="og:url" content="https://robinrendle.com">
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{title}}">
    <meta property="og:description" content="{{ extract | default(metadata.description) }}">
    <meta property="og:image" content="/images/favicons5/bird1.png">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: dark)">
    <meta name="fediverse:creator" content="@fonts@sfba.social">

    <link rel="icon" type="image/png" href="/images/favicons5/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/svg+xml" href="/images/favicons5/favicon.svg"/>
    <link rel="shortcut icon" href="/images/favicons5/favicon.ico"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons5/apple-touch-icon.png"/>
    <link rel="manifest" href="/images/favicons5/site.webmanifest"/>
    <link rel="alternate" type="application/rss+xml" title="Notes" href="/feed.xml">
    <link rel="alternate" type="application/rss+xml" title="The Cascade" href="/cascadefeed.xml">
    <link rel="alternate" type="application/rss+xml" title="Personal newsletter" href="/newsletterfeed.xml">
    <link rel="alternate" type="application/rss+xml" title="Essays" href="/essayfeed.xml">
    {%- css %}{% include "public/css/base.css" %}{% endcss %}
    <style>
      {% getBundle "css" %}
    </style>
  </head>
  <body class="{% if heroImg %}hero-img-active{% endif %}">
    <nav class="sidebar sidebar-main">
      <a href="{% if page.url == '/' %}/about{% else %}/{% endif %}" class="sidebar-link">
        <svg id="logo" class="sidebar-logo" xmlns="http://www.w3.org/2000/svg" version="1.1" width="36" height="37" viewBox="0 0 36 37" fill="none">
          <path d="M35.2 18.1992C35.2 8.69992 27.4993 0.999219 18 0.999219C8.5007 0.999219 0.8 8.69992 0.8 18.1992C0.8 27.6985 8.5007 35.3992 18 35.3992C27.4993 35.3992 35.2 27.6985 35.2 18.1992Z" fill="white"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M18 1.79922C8.94253 1.79922 1.6 9.14175 1.6 18.1992C1.6 27.2567 8.94253 34.5992 18 34.5992C27.0575 34.5992 34.4 27.2567 34.4 18.1992C34.4 9.14175 27.0575 1.79922 18 1.79922ZM0 18.1992C0 8.25809 8.05887 0.199219 18 0.199219C27.9411 0.199219 36 8.25809 36 18.1992C36 28.1403 27.9411 36.1992 18 36.1992C8.05887 36.1992 0 28.1403 0 18.1992Z" fill="black"></path>
          <path d="M31.1243 28.6702C30.5574 25.4791 29.1972 22.4986 27.2238 20.0084C27.2957 19.7203 27.3677 19.4323 27.4399 19.1445C28.8799 19.0726 30.3199 17.9926 30.3199 17.7045C30.3199 17.4165 29.0238 15.9764 27.5838 15.6884C27.4399 14.3923 27.0077 13.1684 26.3599 12.0884C24.8479 9.35227 22.0399 7.40839 18.6559 7.04839C16.2798 6.83229 13.9759 7.33644 12.1759 8.63227C9.79977 10.2884 6.63201 14.8963 6.63201 14.8963L0.636454 22.5591C2.68757 29.734 9.46072 35 17.5 35C19.0071 35 20.4696 34.8149 21.865 34.4669C18.7567 31.4382 15.9198 28.5769 15.9198 28.5769C12.1037 24.6888 12.0317 18.5689 15.6317 14.7529C17.5756 12.6648 20.0956 11.5848 22.9037 11.5848C23.3357 11.5848 23.8399 11.5848 24.2718 11.6568C24.5598 12.0168 24.8479 12.4487 25.0637 12.8807L25.2076 13.0968C25.9996 14.6087 26.2876 16.2648 26.1438 17.9206C26.0721 18.4943 25.9289 19.0676 25.7856 19.6413L25.7838 19.6487L25.5677 20.3687L26.0716 20.9448C28.2099 23.6044 29.4793 26.755 29.8252 30.0684C30.2841 29.6261 30.7179 29.1593 31.1243 28.6702Z" fill="black"></path>
          <path d="M20.7437 17.7045C21.3006 17.7045 21.7518 17.2533 21.7518 16.6967C21.7518 16.1398 21.3006 15.6886 20.7437 15.6886C20.1871 15.6886 19.7359 16.1398 19.7359 16.6967C19.7359 17.2533 20.1871 17.7045 20.7437 17.7045Z" fill="black"></path>
        </svg>
        <div class="sidebar-title">
          {% if page.url == '/' %}
          Robin Rendle is a British software designer, writer, and typographic nuisance from San Francisco.
          {% else %}
          Robin Rendle

            <time datetime="{{ page.date | htmlDateString }}">{{ page.date | dinkyDate }}</time>
          {% endif %}
        </div>
      </a>
    </nav>
    <main>
      <c-page>
        <page-content>
          {{ content | safe }}
        </page-content>
      </c-page>
    </main>
    <script>
      (function() {
        const firstArticle = document.querySelector('.note-article');
        if (!firstArticle) return;

        const loader = document.getElementById('infinite-scroll-loader');
        const pageContent = document.querySelector('page-content');
        const isHomepage = window.location.pathname === '/';

        let isLoading = false;
        let loadedUrls = new Set([firstArticle.dataset.url]);
        let currentArticle = firstArticle;

        function getDistanceFromBottom() {
          const scrollHeight = document.documentElement.scrollHeight;
          const scrollTop = window.scrollY;
          const clientHeight = window.innerHeight;
          return scrollHeight - (scrollTop + clientHeight);
        }

        async function loadNextPost() {
          const nextUrl = currentArticle.dataset.nextUrl;

          if (!nextUrl || isLoading || loadedUrls.has(nextUrl)) {
            return;
          }

          isLoading = true;
          loader.style.display = 'block';

          try {
            const response = await fetch(nextUrl);
            const html = await response.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newArticle = doc.querySelector('.note-article');

            if (newArticle) {
              loadedUrls.add(nextUrl);

              pageContent.appendChild(newArticle);
              currentArticle = newArticle;

              if (isHomepage) {
                const h1 = newArticle.querySelector('h1');
                if (h1 && !h1.querySelector('a')) {
                  const link = document.createElement('a');
                  link.href = nextUrl;
                  link.textContent = h1.textContent;
                  h1.textContent = '';
                  h1.appendChild(link);
                }
              }

              if (!isHomepage) {
                history.pushState({ url: nextUrl }, '', nextUrl);

                const newTitle = doc.querySelector('title').textContent;
                document.title = newTitle;

                const sidebarTime = document.querySelector('.sidebar-title time');
                if (sidebarTime && newArticle.dataset.time) {
                  sidebarTime.datetime = newArticle.dataset.datetime;
                  sidebarTime.textContent = newArticle.dataset.time;
                }
              }
            }
          } catch (error) {
            console.error('Error loading next post:', error);
          } finally {
            loader.style.display = 'none';
            isLoading = false;
          }
        }

        function handleScroll() {
          const distance = getDistanceFromBottom();

          if (distance < 10 && !isLoading) {
            loadNextPost();
          }
        }

        let scrollTimeout;
        window.addEventListener('scroll', () => {
          if (scrollTimeout) return;
          scrollTimeout = setTimeout(() => {
            handleScroll();
            scrollTimeout = null;
          }, 100);
        }, { passive: true });

        if (!isHomepage) {
          window.addEventListener('popstate', (event) => {
            if (event.state && event.state.url) {
              window.location.href = event.state.url;
            }
          });

          history.replaceState({ url: firstArticle.dataset.url }, '', firstArticle.dataset.url);
        }
      })();
    </script>
  </body>
</html>
